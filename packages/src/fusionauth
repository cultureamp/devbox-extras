#!/bin/sh

# resolve links - $0 may be a softlink
PRG="$0"

while [ -h "$PRG" ]; do
  ls=`ls -ld "$PRG"`
  link=`expr "$ls" : '.*-> \(.*\)$'`
  if expr "$link" : '/.*' > /dev/null; then
    PRG="$link"
  else
    PRG=`dirname "$PRG"`/"$link"
  fi
done

# Get standard environment variables
PRGDIR=`dirname "$PRG"`

# TODO: set CATALINA_HOME as directory relative to $out
CATALINA_HOME=`cd "$PRGDIR/.." >/dev/null; pwd`
CATALINA_BASE="$CATALINA_HOME"
FUSIONAUTH_PLUGIN_DIR=${CATALINA_HOME}/../../plugins
FUSIONAUTH_CONFIG_DIR=${CATALINA_HOME}/../../config
FUSIONAUTH_LOG_DIR=/tmp/fusion-auth/logs
CATALINA_OUT=${FUSIONAUTH_LOG_DIR}/fusionauth-app.log
CATALINA_OPTS="-Dfusionauth.home.directory=$CATALINA_HOME/.. -Dfusionauth.config.directory=$FUSIONAUTH_CONFIG_DIR -Dfusionauth.log.directory=$FUSIONAUTH_LOG_DIR -Dfusionauth.plugin.directory=$FUSIONAUTH_PLUGIN_DIR"
JAVA_OPTS=" -Djava.awt.headless=true"
JAVA_OPTS=$(echo ${JAVA_OPTS}|tr -d '\r')

# if [ ! -d ${CATALINA_HOME}/logs ]; then
#   mkdir -p ${CATALINA_HOME}/logs
# fi

if [ ! -d ${FUSIONAUTH_JAVA_DIR} ]; then
  mkdir -p ${FUSIONAUTH_JAVA_DIR}
fi

if [ ! -d ${FUSIONAUTH_LOG_DIR} ]; then
  mkdir -p ${FUSIONAUTH_LOG_DIR}
fi

# What is the nix store path that satisfies this?
JAVA_PATH="/nix/store/aba2qqq0a1v0mixqddr9mr4d1iswiciz-zulu8.54.0.21-ca-jdk-8.0.292/"

# from setclasspath
JAVA_HOME="$JAVA_PATH"/
_RUNJAVA="$JAVA_HOME"/bin/java
_RUNJDB="$JAVA_HOME"/bin/jdb
if [ ! -z "$CLASSPATH" ] ; then
  CLASSPATH="$CLASSPATH":
fi

# How can I replace the below './result' with the nix store path?
CLASSPATH="./result/fusionauth-app/apache-tomcat/bin/bootstrap.jar"
echo "$CLASSPATH"
# end setclasspath

CATALINA_TMPDIR="$CATALINA_BASE"/temp
# TODO: set below path to relative to $out
CLASSPATH=$CLASSPATH:$CATALINA_BASE/bin/tomcat-juli.jar
JSSE_OPTS="-Djdk.tls.ephemeralDHKeySize=2048"
JAVA_OPTS="$JAVA_OPTS $JSSE_OPTS"
JAVA_OPTS="$JAVA_OPTS -Djava.protocol.handler.pkgs=org.apache.catalina.webresources"
# TODO: set below path to relative to $out
LOGGING_CONFIG="-Djava.util.logging.config.file=$CATALINA_BASE/conf/logging.properties"
LOGGING_MANAGER="-Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager"

UMASK="0027"
umask $UMASK

JAVA_OPTS="$JAVA_OPTS -Dorg.apache.catalina.security.SecurityListener.UMASK=`umask`"

JDK_JAVA_OPTIONS="$JDK_JAVA_OPTIONS --add-opens=java.base/java.lang=ALL-UNNAMED"
JDK_JAVA_OPTIONS="$JDK_JAVA_OPTIONS --add-opens=java.base/java.io=ALL-UNNAMED"
JDK_JAVA_OPTIONS="$JDK_JAVA_OPTIONS --add-opens=java.rmi/sun.rmi.transport=ALL-UNNAMED"
export JDK_JAVA_OPTIONS

# TODO solve  Error: Could not find or load main class org.apache.catalina.startup.Bootstrap
# add nix store output to classpath
eval $_NOHUP "\"$_RUNJAVA\"" "\"$LOGGING_CONFIG\"" $LOGGING_MANAGER $JAVA_OPTS $CATALINA_OPTS \
  -D$ENDORSED_PROP="\"$JAVA_ENDORSED_DIRS\"" \
  -classpath "\"$CLASSPATH\"" \
  -Dcatalina.base="\"$CATALINA_BASE\"" \
  -Dcatalina.home="\"$CATALINA_HOME\"" \
  -Djava.io.tmpdir="\"$CATALINA_TMPDIR\"" \
  org.apache.catalina.startup.Bootstrap "$@" start \
  >> "$CATALINA_OUT" 2>&1 "&"
