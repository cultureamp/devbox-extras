version: "0.5"

processes:
  README_DEBEZIUM:
    command: "devbox run debezium-server-readme; tail -f /dev/null"
    availability:
      restart: always

  debezium-server-install-deps:
    command: devbox run debezium-server-install-deps

  debezium-server-init-topic:
    command: devbox run debezium-server-create-heartbeat-topic
    depends_on:
      kafka_local:
        condition: process_healthy

  debezium-server-init-outbox:
    command: devbox run debezium-server-init-outbox
    depends_on:
      debezium-server-postgres-invariant-checks:
        condition: process_completed_successfully
      debezium-server-postgres-wait:
        condition: process_healthy

  debezium-server-postgres-wait:
    command: "echo 'Waiting on postgresql at ${_DEBEZIUM_SERVER_DB_HOSTNAME}:${_DEBEZIUM_SERVER_DB_PORT}...'; tail -f /dev/null"
    readiness_probe:
      period_seconds: 5
      failure_threshold: 1000
      exec:
        command: pg_isready -h ${_DEBEZIUM_SERVER_DB_HOSTNAME} -U postgres -p ${_DEBEZIUM_SERVER_DB_PORT}

  debezium-server-postgres-invariant-checks:
    command: devbox run debezium-server-postgres-version-check

  debezium-server:
    working_dir: {{.Virtenv}}
    command: run_debezium
    depends_on:
      debezium-server-install-deps:
        condition: process_completed_successfully
      debezium-server-init-outbox:
        condition: process_completed_successfully
      debezium-server-init-topic:
        condition: process_completed_successfully
    availability:
      restart: on_failure
