{
  "name": "debezium-server",
  "version": "0.1.1",
  "description": "Plugin for running Debezium Server locally",
  "packages": [
    "nodejs@22.4.1",
    "pnpm@9.7.0",
    "github:cultureamp/devbox-extras#debezium-server"
  ],
  "env": {
    "DEVBOX_COREPACK_ENABLED": "true",
    "CONNECTOR_CONF_PATH": "{{.Virtenv}}",
    "DEBEZIUM_OPTS": "",
    "JAVA_OPTS": "",
    "_DEBEZIUM_SERVER_DB_HOSTNAME": "localhost",
    "_DEBEZIUM_SERVER_DB_PORT": "5432",
    "_DEBEZIUM_SERVER_DB_AUTH_USERNAME": "postgres",
    "_DEBEZIUM_SERVER_DB_AUTH_PASSWORD": "postgres",
    "_DEBEZIUM_SERVER_DB_USERNAME": "dbz_user",
    "_DEBEZIUM_SERVER_DB_PASSWORD": "mydbzpassword",
    "_DEBEZIUM_SERVER_DB_NAME": "postgres",
    "_DEBEZIUM_SERVER_DB_SCHEMA": "public",
    "_DEBEZIUM_SERVER_FARM": "local",
    "_DEBEZIUM_SERVER_INTERNAL_TOPIC_PREFIX": "my_test_prefix",
    "_DEBEZIUM_SERVER_SLOT_NAME": "my_test_slot",
    "_DEBEZIUM_SERVER_OFFSET_TOPIC": "my_test_offset_topic",
    "_DEBEZIUM_SERVER_PUBLICATION_NAME": "dbz_publication",
    "_DEBEZIUM_SERVER_OUTBOX_TABLE": "outbox_table",
    "_DEBEZIUM_SERVER_HEARTBEAT_TABLE": "debezium_heartbeat",
    "_DEBEZIUM_SERVER_TARGET_TOPIC": "my_target_topic",
    "_DEBEZIUM_SERVER_SCHEMA_PATH": "com.cultureamp.test.user.v1-value.avsc",
    "_DEBEZIUM_SERVER_SAMPLE_DATA_PATH": "sample-data.json"
  },
  "shell": {
    "scripts": {
      "debezium-server-install-deps": [
        "pnpm install -C {{.Virtenv}}"
      ],
      "debezium-server-init-outbox": [
        "psql -v debezium_user=${_DEBEZIUM_SERVER_DB_USERNAME} \\",
        "-v debezium_password=${_DEBEZIUM_SERVER_DB_PASSWORD} \\",
        "-v schema_name=${_DEBEZIUM_SERVER_DB_SCHEMA} \\",
        "-v outbox_table_name=${_DEBEZIUM_SERVER_OUTBOX_TABLE} \\",
        "-v heartbeat_table_name=${_DEBEZIUM_SERVER_HEARTBEAT_TABLE} \\",
        "-h ${_DEBEZIUM_SERVER_DB_HOSTNAME} \\",
        "-p ${_DEBEZIUM_SERVER_DB_PORT} \\",
        "-U ${_DEBEZIUM_SERVER_DB_AUTH_USERNAME} \\",
        "${_DEBEZIUM_SERVER_DB_NAME} < {{.Virtenv}}/init_outbox.sql"
      ],
      "debezium-server-create-db": [
        "dropdb -h ${_DEBEZIUM_SERVER_DB_HOSTNAME} -p ${_DEBEZIUM_SERVER_DB_PORT} -U ${_DEBEZIUM_SERVER_DB_AUTH_USERNAME} --if-exists ${_DEBEZIUM_SERVER_DB_NAME}",
        "createdb -h ${_DEBEZIUM_SERVER_DB_HOSTNAME} -p ${_DEBEZIUM_SERVER_DB_PORT} -U ${_DEBEZIUM_SERVER_DB_AUTH_USERNAME} ${_DEBEZIUM_SERVER_DB_NAME}"
      ],
      "debezium-server-create-heartbeat-topic": [
        "kaf topic create _${_DEBEZIUM_SERVER_FARM}.${_DEBEZIUM_SERVER_INTERNAL_TOPIC_PREFIX}.debezium-heartbeat-table -p 1 -r 1 || true"
      ],
      "debezium-server-populate": [
        "pnpm run -C {{.Virtenv}} populate"
      ],
      "debezium-server-reset-offset": [
        "devbox services stop debezium-server && \\",
        "PID=$(ps aux | grep '[i]o.debezium.server.Main' | awk '{print $2}' | head -n 1) && \\",
        "[ -n \"$PID\" ] && timeout=0; while ps -p $PID > /dev/null && [ $timeout -lt 10 ]; do echo 'Waiting for debezium server to stop..'; sleep 1; ((timeout++)); done && \\",
        "echo \"Tombstoning connector offset\"",
        "echo \"[\\\"kafka\\\",{\\\"server\\\":\\\"${_DEBEZIUM_SERVER_FARM}.${_DEBEZIUM_SERVER_INTERNAL_TOPIC_PREFIX}\\\"}]|\" | \\",
        "kcat -P -Z -b ${_DEBEZIUM_SERVER_KAFKA_BROKERS_SASL} -X sasl.mechanism=PLAIN -X sasl.username=${_DEBEZIUM_SERVER_KAFKA_SASL_USER} -X sasl.password=${_DEBEZIUM_SERVER_KAFKA_SASL_PASSWORD} -t ${_DEBEZIUM_SERVER_OFFSET_TOPIC} -K \\| -p 0 && \\",
        "echo \"Restarting debezium server\" && \\",
        "devbox services start debezium-server"
      ],
      "debezium-server-readme": "{{.Virtenv}}/bin/debezium-server-readme",
      "debezium-server-postgres-version-check": "{{.Virtenv}}/bin/postgres-version-check"
    }
  },
  "create_files": {
    "{{.Virtenv}}/process-compose.yaml": "config/process-compose.yaml",
    "{{.Virtenv}}/application.properties": "config/debezium-server/application.properties",
    "{{.Virtenv}}/init_outbox.sql": "config/debezium-server/init_outbox.sql",
    "{{.Virtenv}}/bin/debezium-server-readme": "bin/debezium-server-readme",
    "{{.Virtenv}}/bin/postgres-version-check": "bin/postgres-version-check",
    "{{.Virtenv}}/package.json": "config/populate/package.json",
    "{{.Virtenv}}/tsconfig.json": "config/populate/tsconfig.json",
    "{{.Virtenv}}/sample-data.json": "config/populate/sample-data.json",
    "{{.Virtenv}}/populate.ts": "bin/populate.ts",
    "{{.Virtenv}}/com.cultureamp.test.user.v1-value.avsc": "config/populate/com.cultureamp.test.user.v1-value.avsc"
  }
}
