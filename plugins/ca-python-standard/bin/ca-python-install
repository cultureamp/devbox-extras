#!/usr/bin/env bash
set -e

poetry_repos="$(poetry config repositories)"

if [[ "$poetry_repos" != "{}" && "${POETRY_CA_PRIVATE_PYTHON:-true}" == "true" ]] ; then
    echo "Setting up helpers for installing private python packages and checking config"

    echo "Adding Culture Amp private package source"
    poetry source add ca-codeartifact-default https://cultureamp-python-ci-226140413739.d.codeartifact.us-west-2.amazonaws.com/pypi/cultureamp-private-python-repo/simple --priority=supplemental

    echo "Setting up poetry-codeartifact-auth"
    .venv/bin/pip install setuptools --quiet --disable-pip-version-check
    .venv/bin/pip install git+https://github.com/cultureamp/poetry-codeartifact-auth.git --quiet --disable-pip-version-check

    # set up environment for poetry-ca-auth
    export POETRY_CA_AUTH_METHOD="environment"
    remote_url="$(git config --get remote.origin.url)"

    # set up granted environment
    export GRANTED_ALIAS_CONFIGURED="true"

    # if remote_url uses https, use https link to registry
    # if remote_url uses git@link, use ssh link to registry
    if [[ "$remote_url" == https://* ]]; then
        url=https://github.com/cultureamp/local-ops
    elif [[ "$remote_url" == git@* ]]; then
        url=git@github.com:cultureamp/local-ops.git
    else
        echo "failed to setup poetry-ca-auth: cannot determine git connection method for granted registry"
        exit 1
    fi

    # add profile registry
    .devbox/nix/profile/default/bin/granted registry add -n local-ops -u $url -p granted-registry

    .devbox/nix/profile/default/bin/assume CodeArtifactRole -pt --no-prompt --exec 'poetry-ca-auth refresh'
fi

## running twice seems to get around auth issues on headless systems
poetry -v install || poetry -v install || exit 1
echo "Devbox setup has completed poetry install"
pre-commit install --install-hooks || echo "WARNING: could not install pre-commit hooks" >&2
