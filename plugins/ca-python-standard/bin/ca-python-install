#!/usr/bin/env bash
set -e

poetry_repos="$(poetry config repositories)"

# we will always assume engineers using this plugin want access to private packages
# and are usng poetry-codeartifact-auth
echo "Setting up helpers for installing private python packages and checking config"

echo "Adding Culture Amp private package source"
poetry source add ca-codeartifact-default https://cultureamp-python-ci-226140413739.d.codeartifact.us-west-2.amazonaws.com/pypi/cultureamp-private-python-repo/simple --priority=supplemental

# set up environment for granted
export GRANTED_ALIAS_CONFIGURED="true"
unset AWS_ACCESS_KEY_ID
unset AWS_SECRET_ACCESS_KEY
# use environment granted to assume role in bin/codeartifact-role-config
.devbox/nix/profile/default/bin/assume --aws-config-file .devbox/virtenv/ca-python-standard/bin/codeartifact-role-config CodeArtifactRole -pt --no-prompt

echo "Setting up poetry-codeartifact-auth"
.venv/bin/pip install setuptools --quiet --disable-pip-version-check
.venv/bin/pip install git+https://github.com/cultureamp/poetry-codeartifact-auth.git --quiet --disable-pip-version-check

## running twice seems to get around auth issues on headless systems
poetry -v install || poetry -v install || exit 1
echo "Devbox setup has completed poetry install"
echo "If a package does not appear to have installed, try reloading your window"
pre-commit install --install-hooks || echo "WARNING: could not install pre-commit hooks" >&2
