#!/usr/bin/env bash
set -e

# we will always assume engineers using this plugin want access to private packages
# and are usng poetry-codeartifact-auth
echo "Setting up helpers for installing private python packages and checking config"

echo "Adding Culture Amp private package source"
poetry source add ca-codeartifact-default https://cultureamp-python-ci-226140413739.d.codeartifact.us-west-2.amazonaws.com/pypi/cultureamp-private-python-repo/simple --priority=supplemental

echo "Setting up poetry-codeartifact-auth"
.venv/bin/pip install setuptools --quiet --disable-pip-version-check
.venv/bin/pip install git+https://github.com/cultureamp/poetry-codeartifact-auth.git --quiet --disable-pip-version-check

# set up environment for poetry-ca-auth
export POETRY_CA_AUTH_METHOD="environment"
# granted environment
export GRANTED_ALIAS_CONFIGURED="true"
granted browser set
# add profile registry
url=https://github.com/cultureamp/delivery-eng-experiments.git
granted registry add -n delivery-eng-experiments -u $url -p 009-2-devbox-python-poetry/granted-registry

assume CodeArtifactRole -pt --no-prompt --env
# use .env to store variables for auth usage
source .env
export AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
export AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
export AWS_SESSION_TOKEN=${AWS_SESSION_TOKEN}

poetry-ca-auth refresh

## running twice seems to get around auth issues on headless systems
poetry -v install || poetry -v install || exit 1
echo "Devbox setup has completed poetry install"
echo "If a package does not appear to have installed, try reloading your window"
pre-commit install --install-hooks || echo "WARNING: could not install pre-commit hooks" >&2
