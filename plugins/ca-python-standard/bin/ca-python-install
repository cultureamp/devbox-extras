#!/usr/bin/env bash
set -e

poetry_repos="$(poetry config repositories)"

# we will always assume engineers using this plugin want access to private packages
# and are usng poetry-codeartifact-auth
echo "Setting up helpers for installing private python packages and checking config"

echo "Adding Culture Amp private package source"
poetry source add ca-codeartifact-default https://cultureamp-python-ci-226140413739.d.codeartifact.us-west-2.amazonaws.com/pypi/cultureamp-private-python-repo/simple --priority=supplemental

auth_method="${POETRY_CA_AUTH_METHOD:-environment}"
if [[ "${auth_method}" == "environment" ]] ; then
  if [[ -z "$AWS_ACCESS_KEY_ID" ]] ; then
    echo "AWS environment credentials not found"
  fi
fi

if [[ "${auth_method}" == "sso" || "${auth_method}" == "vault" ]] ; then
  if [[ -z "$POETRY_CA_DEFAULT_AWS_PROFILE" ]] ; then
    cat >&2 <<'EOF'
#############################################################################
NOTE: `POETRY_CA_DEFAULT_AWS_PROFILE` environment variable is unset
If using granted, set `POETRY_CA_AUTH_METHOD` to `environment`
If using sso or vault, set a value for `POETRY_CA_DEFAULT_AWS_PROFILE` and try again
#############################################################################
EOF
    exit 1
  fi
fi

echo "Setting up poetry-codeartifact-auth"
.venv/bin/pip install setuptools --quiet --disable-pip-version-check
.venv/bin/pip install git+https://github.com/cultureamp/poetry-codeartifact-auth.git --quiet --disable-pip-version-check

if [[ "${auth_method}" == "sso" ]] ; then
  poetry-ca-auth refresh
fi


## running twice seems to get around auth issues on headless systems
poetry -v install || poetry -v install || exit 1
echo "Devbox setup has completed poetry install"
echo "If a package does not appear to have installed, try reloading your window"
pre-commit install --install-hooks || echo "WARNING: could not install pre-commit hooks" >&2
